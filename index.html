<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>PPI</title>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
    <link href="style.css" rel="stylesheet"></link>
  </head>
  <body>
    <div id="page">
      <div id="circle"></div>
      <div id="s_to_s_tablet">
	<p>Single-to-Single Link</p>
	<input type="text" name="s_to_s_string" placeholder="Typing the pair..." /><br />
	<span>ex: 1-2, 4-3, ...</span>
	<button id="s_to_s_submit_linking" onclick="s_to_s_link()">Link</button>
      </div>
      <div id="m_to_m_tablet">
	<p>Multiple-to-Multiple Link</p>
	<div id="source_block">
	  <center><p>Source</p></center>
	  <button id="s_1" class="s_number" onclick="number_button('s_1')">1</button><button id="s_2" class="s_number" onclick="number_button('s_2')">2</button><button id="s_3" class="s_number" onclick="number_button('s_3')">3</button><button id="s_4" class="s_number" onclick="number_button('s_4')">4</button><br />
	  <button id="s_5" class="s_number" onclick="number_button('s_5')">5</button><button id="s_6" class="s_number" onclick="number_button('s_6')">6</button><button id="s_7" class="s_number" onclick="number_button('s_7')">7</button><button id="s_8" class="s_number" onclick="number_button('s_8')">8</button><br />
	  <button id="s_9" class="s_number" onclick="number_button('s_9')">9</button><button id="s_10" class="s_number" onclick="number_button('s_10')">10</button><button id="s_11" class="s_number" onclick="number_button('s_11')">11</button><button id="s_12" class="s_number" onclick="number_button('s_12')">12</button><br />
	  <button id="s_13" class="s_number" onclick="number_button('s_13')">13</button><button id="s_14" class="s_number" onclick="number_button('s_14')">14</button><button id="s_15" class="s_number" onclick="number_button('s_15')">15</button><button id="s_16" class="s_number" onclick="number_button('s_16')">16</button><br />
	  <button id="s_a" class="control_all" onclick="all_button('s')">All</button><button id="s_c" class="control_all" onclick="clean_button('s')">Clean</button>
	</div>
	<div id="target_block">
	  <center><p>Target</p></center>
	  <button id="t_1" class="t_number" onclick="number_button('t_1')">1</button><button id="t_2" class="t_number" onclick="number_button('t_2')">2</button><button id="t_3" class="t_number" onclick="number_button('t_3')">3</button><button id="t_4" class="t_number" onclick="number_button('t_4')">4</button><br />
	  <button id="t_5" class="t_number" onclick="number_button('t_5')">5</button><button id="t_6" class="t_number" onclick="number_button('t_6')">6</button><button id="t_7" class="t_number" onclick="number_button('t_7')">7</button><button id="t_8" class="t_number" onclick="number_button('t_8')">8</button><br />
	  <button id="t_9" class="t_number" onclick="number_button('t_9')">9</button><button id="t_10" class="t_number" onclick="number_button('t_10')">10</button><button id="t_11" class="t_number" onclick="number_button('t_11')">11</button><button id="t_12" class="t_number" onclick="number_button('t_12')">12</button><br />
	  <button id="t_13" class="t_number" onclick="number_button('t_13')">13</button><button id="t_14" class="t_number" onclick="number_button('t_14')">14</button><button id="t_15" class="t_number" onclick="number_button('t_15')">15</button><button id="t_16" class="t_number" onclick="number_button('t_16')">16</button><br />
	  <button id="t_a" class="control_all" onclick="all_button('t')">All</button><button id="t_c" class="control_all" onclick="clean_button('t')">Clean</button>
	</div>
	<button id="reset" onclick="reset()">Reset</button>
      </div>
    </div>

    <script>
      var s_tunnel = [],
      t_tunnel = [];
      function number_button(signal) {
	if($("#"+signal).css("background-color") == "rgb(255, 255, 255)") {
	  $("#"+signal).css("background-color", "#606c88").css("color", "White");
	  tunnel_add(signal);
	}
	else {
	  $("#"+signal).css("background-color", "#FFF").css("color", "#666");
	  tunnel_delete(signal);
	}
      }
      function all_button(signal) {
	$("." + signal + "_number").css("background-color", "#606c88").css("color", "White");
	if(signal == "s") {
	  s_tunnel.splice(0, s_tunnel.length);
	  for(var i = 1; i <= CHR_NUMBER; i++) {
	    s_tunnel.push(i);
	  }
	}
	else {
	  t_tunnel.splice(0, s_tunnel.length);
	  for(var i = 1; i <= CHR_NUMBER; i++) {
	    t_tunnel.push(i);
	  }
	}
	for(var i = 0; i < s_tunnel.length; i++) {
	  for(var j = 0; j < t_tunnel.length; j++) {
	    sketch_line(s_tunnel[i], t_tunnel[j]);
	  }
	}
      }
      function clean_button(signal) {
	$("." + signal + "_number").css("background-color", "#FFF").css("color", "#666");
	for(var i = 0; i < s_tunnel.length; i++) {
	  for(var j = 0; j < t_tunnel.length; j++) {
	    group.select("#chr" + s_tunnel[i] + "-" + t_tunnel[j] + "_line_set").remove();
	  }
	}
	if(signal == "s") {
	  s_tunnel.splice(0, s_tunnel.length);
	}
	else {
	  t_tunnel.splice(0, t_tunnel.length);
	}
      }
      function tunnel_add(signal) {
	var line = signal.split("_");
	if(line[0] == "s") {
	  s_tunnel.push(parseInt(line[1]));
	  for(var i = 0; i < t_tunnel.length; i++) {
	    sketch_line(line[1], t_tunnel[i]);
	  }
	}
	else if(line[0] == "t") {
	  t_tunnel.push(parseInt(line[1]));
	  for(var i = 0; i < s_tunnel.length; i++) {
	    sketch_line(s_tunnel[i], line[1]);
	  }
	}
	else {
	  console.log("Error: function tunnel_push");
	}
      }
      function tunnel_delete(signel) {
	var line = signel.split("_");
	var delete_index;
	if(line[0] == "s") {
	  for(var i = 0; i < s_tunnel.length; i++) {
	    if(s_tunnel[i] == line[1]) {
	      delete_index = i;
	      break;
	    }
	  }
	  for(var i = 0; i < t_tunnel.length; i++) {
	    group.select("#chr" + line[1] + "-" + t_tunnel[i] + "_line_set").remove();
	  }
	  s_tunnel.splice(delete_index, 1);
	}
	else if(line[0] == "t") {
	  for(var i = 0; i < t_tunnel.length; i++) {
	    if(t_tunnel[i] == line[1]) {
	      delete_index = i;
	      break;
	    }
	  }
	  for(var i = 0; i < s_tunnel.length; i++) {
	    group.select("#chr" + s_tunnel[i] + "-" + line[1] + "_line_set").remove();
	  }
	  t_tunnel.splice(delete_index, 1);
	}
	else {
	  console.log("Error: function tunnel_delete");
	}
      }
      function reset() {
	clean_button("s");
	clean_button("t");
      }
      function s_to_s_link() {
	var text = $("input[type=text]").val().replace(/\s+/g, '');
	var line = text.split(",");
	line.forEach(function(element) {
	  var sep = element.split("-");
	  var source = parseInt(sep[0]);
	  var target = parseInt(sep[1]);
	  if( source > 0 && source <= CHR_NUMBER && target > 0 && target <= CHR_NUMBER) {
	    sketch_line(source, target);
	  }
	  else {
	    alert("Error: Wrong formatting input.");
	  }
	});
      }


      //Adjustable circle layout which base on the size of user's screen
      var outer_radius = 960 * 0.5 * 0.5,
      inner_radius = outer_radius * 0.8,
      circle_horizontal_shift = 320,
      circle_vertical_shift = outer_radius * 1.3,
      circle_radius = d3.svg.arc().innerRadius(inner_radius).outerRadius(outer_radius);

      //Amounts of the chromosomes
      var CHR_NUMBER = 16;

      //16 kinds of color for fillng to each chromosome
      var chr_color = ["#D4C3A7", "#72783C", "#A8A24E", "#B53A3F", "#F32733", "#FE2488", "#F6D3D1", "#F4A441", "#FFC84D", "#F9E956", "#D4DF54", "#03AA58", "#2B954A", "#30368C", "#59A3D4", "#8FCAE8" ];

      //Length of each chromosome
      var length = [229308, 810334, 315994, 1530848, 575675, 269503, 1089753, 561199, 435270, 744905, 662927, 1077048, 923492, 783287, 1090013, 946852];
      var length_sum = d3.sum(length);

      //The foundation of the circle layout
      var canvas = d3.select("#circle").append("svg"),
      group = canvas.append("g").attr("transform","translate(" + circle_horizontal_shift + ", " + circle_vertical_shift +")");
      //group.append("svg:circle").attr("r", inner_radius * 0.99).attr("fill", "#DDD");
      //group.append("svg:text").text("L o a d i n g ...").attr("x", "-55");

      //Distrubute the region for each chromosome 
      var chr_region, chr_set, chr_start_angle, chr_end_angle,
      gap_degree = 20,
      chr_to_chr_gap = ((CHR_NUMBER * gap_degree / 180) / Math.PI) / CHR_NUMBER,
      chr_start_angle_set = [],
      accumulator = 0;

      for(var i = 0; i < CHR_NUMBER; i++) {

	chr_start_angle = accumulator += chr_to_chr_gap;
	chr_end_angle = accumulator += ((length[i] / length_sum) * (2 * Math.PI - chr_to_chr_gap * CHR_NUMBER));
	chr_start_angle_set.push(chr_start_angle);
	chr_set = circle_radius.startAngle(chr_start_angle).endAngle(chr_end_angle);

	chr_region = group.append("g").attr("id", "chr_" + (i + 1) + "_region")
	.attr("onclick","show_line(" + (i + 1) +")")
	.attr("title", "chr " + (i + 1));

	chr_region.append("path").attr("id", "chr_" + (i + 1) + "_set")
	.attr("d", chr_set)
	.attr("fill", "none")
	.attr("stroke", "#000")
	.attr("stroke-width", "2");
      }

      //Draw every genes on their coresponding chromosome region
      for(var i = 1; i <= CHR_NUMBER; i++) { 
	draw_gene(i);
      }
      function draw_gene(i) {
	d3.json("data/info/chr" + i + "_gene_info.json", function(data) {

	  var gene = circle_radius
	  .startAngle(function(d) { return convert_to_angle(d.chr_num, d.start); })
	  .endAngle(function(d) { return convert_to_angle(d.chr_num, d.end); });

	  group.select("#chr_" + i + "_region").selectAll(".chr" + i).data(data).enter().append("path").attr("class", "chr" + i)
	  .attr("id", function(d) { return d.code; })
	  .attr("stroke", chr_color[i - 1])
	  .attr("d", gene)
	  .attr("stroke-width", "0.08");

	});
      }
      //Draw the line of the relationship
      function sketch_line(source, target) {
	d3.json("./data/link/chr" + source + "-" + target + "_gene_link.json", function(data) {

	  var line = d3.svg.line.radial().interpolate("basis")
	  .radius(function(d, i) { if(i == 1 || i == 2) { return inner_radius * 0.6; } else { return inner_radius; } })
	  .angle(function(d) { return d; });

	  group.select("#chr_"+ source + "_region")
	  .selectAll("#chr" + source + "-" + target + "_line_set").data([1]).enter().append("g").attr("id", "chr" + source + "-" + target + "_line_set")
	  .selectAll(".chr" + source + "-" + target + "_line").data(data).enter().append("path").attr("class", "chr" + source + "-" + target + "_line")
	  .attr("d", function(d){
	    var start = convert_to_angle(d.s_chr_num, (d.s_start + d.s_end) * 0.5 );
	    var end = convert_to_angle(d.t_chr_num, (d.t_start + d.t_end ) * 0.5 );
	    return line([start, start, end, end]); 
	  })
	  .attr("stroke", "#000")
	  .attr("stroke-width", "0.08")
	  .attr("stroke", function(d) { return chr_color[d.t_chr_num - 1]; } )
	  .attr("fill", "none");
	});
      }
      function convert_to_angle(num, position) {
	return chr_start_angle_set[num - 1] + (( position / length_sum) * (2 * Math.PI - chr_to_chr_gap * CHR_NUMBER));
      }

      //interaction with client
      function show_line(num) {
	for(var i = 1; i <= CHR_NUMBER; i++) {
	  if(i == num){
	    $("#chr" + i + "_line_set").css("display", "block");
	  }
	  else {
	    $("#chr" + i + "_line_set").css("display", "none");
	  }
	}
      }

    </script>
  </body>
</html>

